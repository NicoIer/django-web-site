{% extends 'extends/project-base.html' %}
{% load project %}
{% load static %}
{% block css %}
	<style>
        .panel-default .panel-heading {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
        }

        .panel-default > .panel-heading a {
            text-decoration: none;
        }

        .panel-default > .panel-heading span {
            padding: 0 5px;
        }

        .right_function_div {
            display: inline;
            float: right;
        }
	</style>
{% endblock css %}

{% block head-content %}
	<ul class="nav navbar-nav">
		{% manage_nav_bar request project %}
	</ul>
{% endblock head-content %}



{% block content %}
	<div class="container-fluid">
		<div class="panel panel-default">
			<!-- Default panel contents -->
			<div class="panel-heading">{{ project.name }}
				<div class="right_function_div">
					<a type="button" class="btn btn-success btn-xs"
					   data-toggle="modal" data-target="#addModal"
					   data-whatever="新建"
					>
						<span class="glyphicon glyphicon-plus" aria-hidden="true">新建</span>
					</a>
					<a type="button" class="btn btn-primary btn-xs"
					   data-toggle="modal" data-target="#addModal"
					   data-whatever="编辑"
					>
						<span class="glyphicon glyphicon-pencil" aria-hidden="true">编辑</span>
					</a>
					<a type="button" class="btn btn-danger btn-xs"
					   data-toggle="modal" data-target="#addModal"
					   data-whatever="删除"
					>
						<span class="glyphicon glyphicon-trash" aria-hidden="true">删除</span>
					</a>
				</div>
			</div>

			<!-- Table -->
			<table class="table">
				<thead>
				<tr>
					<th>文件名</th>
					<th>文件大小</th>
					<th>更新者</th>
					<th>更新时间</th>
					<th>操作</th>
				</tr>
				</thead>
				<tbody>
				{% for file in file_list %}
					<tr>
						<td>
							{% if file.file_type == 2 %}
								<a href="{% url 'file_home' project_id %}?folder_id={{ file.id }}">
									<span class="glyphicon glyphicon-folder-open"></span> {{ file.name }}
								</a>
							{% else %}
								<span class="glyphicon glyphicon-file"></span>
								{{ file.name }}
							{% endif %}
						</td>
						{% if file.file_type == 1 %}
							<td>{{ file.file_size }}</td>
						{% else %}
							<td>-</td>
						{% endif %}
						<td>{{ file.update_user }}</td>
						<td>{{ file.update_datetime }}</td>
						<td>
							<a href="#">编辑</a>
							<a href="#">删除</a>
						</td>
					</tr>
				{% endfor %}
				</tbody>
			</table>
		</div>

	</div>

	<!-- Modal -->
	<div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
							aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" id="myModalLabel">Modal title</h4>
				</div>
				<div class="modal-body">
					<form class="file-form" id="file-form" novalidate>
						{% csrf_token %}
						{% for field in form %}
							<div class="form-group">

								<label for="{{ field.id_for_label }}">{{ field.label }}</label>
								{{ field }}
							</div>
						{% endfor %}
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					<button type="button" class="btn btn-primary" onclick="onSubmitBtnClicked()">Submit</button>
				</div>
			</div>
		</div>
	</div>
{% endblock content %}

{% block js %}
	<script type="text/javascript" src="{% static 'web/js/util.js' %}"></script>
	<script>
        $(function () {
            initAddModal();
        })

        function initAddModal() {
            // 绑定了 bs show 时间
            $('#addModal').on('show.bs.modal', function (event) {
                const button = $(event.relatedTarget); // Button that triggered the modal
                const recipient = button.data('whatever'); // Extract info from data-* attributes
                // If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
                // Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
                const modal = $(this);
                modal.find('.modal-title').text(recipient)
                document.getElementById('file-form').reset()
                {#modal.find('.modal-body input').val(recipient)#}
            })
        }

        function onSubmitBtnClicked() {
            const check_data = form_check('#file-form');
            const file_data = check_data['data'];
            console.log(file_data)
            $.ajax({
                url: location.href,
                type: 'post',
                data: file_data,
                success: function (res) {
                    if (res.status) {
                        console.log('success')
                        location.reload()
                    } else {
                        $.each(res.error, function (key, value) {
                            const id_ = $('#id_' + key);
                            setTimeout(function () {
                                id_.popover('hide')
                            }, 3000);
                            id_.attr('data-content', value)
                            id_.popover('show')
                        })
                    }
                }
            })
        }
	</script>
{% endblock js %}